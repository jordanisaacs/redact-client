<html>
  <head>
    <style>
      {{ Secure.css }}
    </style>
  </head>
  <body>
    {{ #if Secure.edit }}
	<form id="form" action="/data/{{ Secure.token }}?css={{ Secure.css }}&edit={{ Secure.edit }}{{ #if Secure.js_height_msg_prefix }}&js_height_msg_prefix={{ Secure.js_height_msg_prefix }}{{ /if }}{{ #if Secure.js_message }}&js_message={{ Secure.js_message }}{{ /if }}{{ #if Secure.relay_url }}&relay_url={{ Secure.relay_url }}{{ /if }}" method="POST" {{ form_type Secure.data_type }}>
      {{ #if Secure.relay_url }}
      <input type="hidden" value="{{ Secure.relay_url }}" id="relay_url" name="relay_url">
      {{ /if }}
	  {{ #if Secure.js_message }}
	  <input type="hidden" value="{{ Secure.js_message }}" id="js_message" name="js_message">
	  {{ /if }}
      <input type="hidden" value="{{ Secure.path }}" id="path" name="path">
      {{ data_input Secure.data }}
      <input type="submit" value="Submit" name="submit" id="submit">
    </form>
    {{ else }}
        {{ data_display Secure.data }}
    {{ /if }}


	<script>
	{{ #if Secure.js_height_msg_prefix }}
		var clientHeight = document.getElementById('data').clientHeight;
		var message = atob("{{ Secure.js_height_msg_prefix }}") + clientHeight;
		window.parent.postMessage(btoa(message), "*");
	{{/if}}


	{{ #if Secure.js_message }}
	  {{ #if Secure.edit }}
		document.getElementById("form").addEventListener('submit', functSubmit);

		{{#if (eq "binary" Secure.data_type)}}
			document.getElementById("form").enctype = 'multipart/form-data';
			function functSubmit(event) {
				const formTarget = event.target;
				var form = new FormData(formTarget);
				fetch(formTarget.action, {
					method: formTarget.method,
					body: form
				})
				.then((res) => {
				  window.parent.postMessage("{{ Secure.js_message }}", "*");
				  return res.text();
				});
				// Prevent the default form submit
				event.preventDefault();
			  }
		{{ else }}
		  function functSubmit(event) {
			const formTarget = event.target;
			var form = new FormData(formTarget);

			for(const name in data) {
				form.append(name, data[name]);
			}
			var formBody = [];
			for (let [name, value] of form) {
			  var encodedKey = encodeURIComponent(name);
			  var encodedValue = encodeURIComponent(value);
			  formBody.push(encodedKey + "=" + encodedValue);
			}
			formBody = formBody.join("&");

			fetch(formTarget.action, {
			  method: formTarget.method,
			  headers: {
				'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
			  },
			  body: formBody
			})
			.then((res) => {
				window.parent.postMessage("{{ Secure.js_message }}", "*");
			  return res.text();
			});

			// Prevent the default form submit
			event.preventDefault();
		  }
		{{/if}}
	  {{/if}}
	{{/if}}

    </script>
  </body>
</html>
